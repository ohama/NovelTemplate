---
phase: 06-advanced-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - claude_src/novel/schemas/story_state.schema.json
  - claude_src/novel/utils/state-manager.md
  - claude_src/novel/skills/version-manager.md
autonomous: true

must_haves:
  truths:
    - "Snapshots are created automatically after revision cycles"
    - "User can compare two versions using word-level diff"
    - "User can restore a scene from a previous snapshot"
    - "Snapshot metadata tracks trigger, timestamp, and scenes included"
  artifacts:
    - path: "claude_src/novel/skills/version-manager.md"
      provides: "Snapshot creation, diff, and rollback operations"
      min_lines: 200
    - path: "claude_src/novel/schemas/story_state.schema.json"
      provides: "versions object with snapshots array"
      contains: "snapshots"
  key_links:
    - from: "version-manager.md"
      to: "state-manager.md"
      via: "state operations"
      pattern: "state-manager"
    - from: "version-manager.md"
      to: "draft/versions/"
      via: "snapshot storage"
      pattern: "draft/versions"
---

<objective>
Implement file-based version management for draft snapshots with diff and rollback capabilities.

Purpose: Enable writers to track revision history, compare versions, and restore previous drafts. This provides safety during the iterative revision process.
Output: version-manager skill with snapshot, diff, and rollback operations; extended state schema for version tracking.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-advanced-features/06-RESEARCH.md

# Existing state patterns
@claude_src/novel/utils/state-manager.md
@claude_src/novel/schemas/story_state.schema.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create version-manager skill</name>
  <files>claude_src/novel/skills/version-manager.md</files>
  <action>
Create a new skill document that provides version management operations:

**Snapshot Creation:**
- Create `draft/versions/YYYY-MM-DD_HH-MM-SS/` directory
- Generate `manifest.json` with:
  - `snapshot_id`: "snap_YYYY-MM-DD_HH-MM-SS"
  - `timestamp`: ISO 8601 format
  - `trigger`: "revision_cycle" | "manual" | "pre_publish"
  - `scenes_included`: array of scene IDs that were copied
  - `source_commit`: git commit hash if available
- Copy all scenes with status "drafted" or "approved" to snapshot directory
- Update story_state.json versions.snapshots array with new snapshot entry
- Update versions.last_snapshot with snapshot_id

**Version Diff:**
- Accept two snapshot IDs (or "current" for draft/scenes/)
- Use `git diff --no-index --word-diff` for word-level prose comparison
- Fall back to `diff -u` if git unavailable
- Output unified diff format with clear scene identification
- Handle multi-scene diff by iterating through common scenes

**Version Rollback:**
- Accept snapshot_id and optional scene_id (all scenes if not specified)
- Verify snapshot exists in draft/versions/
- Backup current scene(s) to draft/scenes/*.bak before restore
- Copy scene(s) from snapshot to draft/scenes/
- Update story_state.json scene status to "drafted" (reset from approved)
- Log rollback in versions.last_rollback field

**Error Handling:**
- Validate snapshot exists before operations
- Handle missing scenes gracefully (skip with warning)
- Preserve backup files on restore failure

Follow the pattern of state-manager.md for structure, using sections:
- Overview with purpose
- Directory Structure showing draft/versions/ layout
- Operations with step-by-step instructions
- Examples with bash commands
- Error Handling with recovery procedures
  </action>
  <verify>
File exists at claude_src/novel/skills/version-manager.md with 200+ lines.
Contains sections: "Snapshot Creation", "Version Diff", "Version Rollback".
Contains manifest.json structure with snapshot_id, timestamp, trigger, scenes_included.
Contains git diff --word-diff command example.
  </verify>
  <done>
version-manager.md skill provides complete operations for snapshot, diff, and rollback with clear step-by-step instructions and bash examples.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend state schema for version tracking</name>
  <files>claude_src/novel/schemas/story_state.schema.json, claude_src/novel/utils/state-manager.md</files>
  <action>
**Extend story_state.schema.json:**

Add a new `versions` property to the root schema:

```json
"versions": {
  "type": "object",
  "properties": {
    "snapshots": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "snapshot_id": { "type": "string", "pattern": "^snap_\\d{4}-\\d{2}-\\d{2}_\\d{2}-\\d{2}-\\d{2}$" },
          "timestamp": { "type": "string", "format": "date-time" },
          "trigger": { "type": "string", "enum": ["revision_cycle", "manual", "pre_publish"] },
          "scenes_count": { "type": "integer", "minimum": 0 }
        },
        "required": ["snapshot_id", "timestamp", "trigger", "scenes_count"]
      },
      "default": []
    },
    "last_snapshot": { "type": "string", "default": "" },
    "last_rollback": {
      "type": "object",
      "properties": {
        "snapshot_id": { "type": "string" },
        "timestamp": { "type": "string", "format": "date-time" },
        "scenes_restored": { "type": "array", "items": { "type": "string" } }
      }
    }
  },
  "default": {
    "snapshots": [],
    "last_snapshot": "",
    "last_rollback": null
  }
}
```

Update schema_version to "1.2" to track this change.

**Extend state-manager.md:**

Add a new section "Version Tracking" after "Revision Tracking" that documents:
- versions object structure
- How to add a new snapshot entry
- How to record rollback events
- Example JSON for versions object

Reference the version-manager.md skill for full operations.
  </action>
  <verify>
grep -q '"versions"' claude_src/novel/schemas/story_state.schema.json
grep -q '"snapshots"' claude_src/novel/schemas/story_state.schema.json
grep -q '"1.2"' claude_src/novel/schemas/story_state.schema.json
grep -q "Version Tracking" claude_src/novel/utils/state-manager.md
  </verify>
  <done>
story_state.schema.json contains versions object with snapshots array, schema_version is "1.2".
state-manager.md documents version tracking fields and references version-manager skill.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create directory template for versions</name>
  <files>claude_src/novel/templates/directories/draft/versions/README.md</files>
  <action>
Create a README.md for the draft/versions/ directory that explains:

1. Purpose: Timestamped snapshots of scene files for version history
2. Structure:
   ```
   versions/
   └── YYYY-MM-DD_HH-MM-SS/
       ├── manifest.json    # Snapshot metadata
       ├── ch01_s01.md      # Scene copies
       └── ...
   ```
3. Triggers: When snapshots are created (revision_cycle, manual, pre_publish)
4. Usage: Reference version-manager.md skill for diff and rollback operations
5. Note: This directory can grow large over time; old snapshots may be pruned manually

Follow the pattern of other README.md files in templates/directories/.
  </action>
  <verify>
File exists at claude_src/novel/templates/directories/draft/versions/README.md.
Contains "manifest.json" reference.
Contains YYYY-MM-DD_HH-MM-SS format description.
  </verify>
  <done>
draft/versions/README.md template exists and documents snapshot directory structure.
  </done>
</task>

</tasks>

<verification>
All three files exist with required content:
1. version-manager.md: 200+ lines with Snapshot, Diff, Rollback sections
2. story_state.schema.json: Contains versions object with snapshots array
3. draft/versions/README.md: Documents snapshot directory structure

Schema version updated to 1.2.
State-manager.md includes Version Tracking section.
</verification>

<success_criteria>
- [ ] version-manager.md skill provides complete snapshot/diff/rollback operations
- [ ] story_state.schema.json extended with versions tracking (v1.2)
- [ ] state-manager.md documents version tracking fields
- [ ] Directory template created for draft/versions/
- [ ] All files follow existing project patterns and conventions
</success_criteria>

<output>
After completion, create `.planning/phases/06-advanced-features/06-01-SUMMARY.md`
</output>
