---
phase: 06-advanced-features
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - claude_src/novel/skills/epub-generator.md
  - claude_src/novel/templates/epub/metadata.yaml
  - claude_src/novel/templates/epub/epub.css
  - claude_src/novel/templates/directories/draft/compiled/README.md
autonomous: true

must_haves:
  truths:
    - "Pandoc converts Markdown scenes to EPUB3 format"
    - "EPUB includes YAML metadata (title, author, language, description)"
    - "EPUB includes automatic table of contents from chapter headings"
    - "Scenes are compiled in correct reading order by chapter and scene number"
  artifacts:
    - path: "claude_src/novel/skills/epub-generator.md"
      provides: "EPUB generation using Pandoc"
      min_lines: 150
    - path: "claude_src/novel/templates/epub/metadata.yaml"
      provides: "Template YAML metadata for Pandoc"
      contains: "title:"
    - path: "claude_src/novel/templates/epub/epub.css"
      provides: "Default EPUB styling"
      contains: "body"
  key_links:
    - from: "epub-generator.md"
      to: "pandoc"
      via: "CLI invocation"
      pattern: "pandoc"
    - from: "epub-generator.md"
      to: "story_state.json"
      via: "scene order lookup"
      pattern: "scene_index"
---

<objective>
Create EPUB export capability using Pandoc with proper metadata, styling, and chapter compilation.

Purpose: Enable writers to export their completed novel as a professional EPUB file suitable for e-readers and distribution platforms.
Output: epub-generator skill with compilation workflow; metadata and CSS templates for EPUB generation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-advanced-features/06-RESEARCH.md

# Existing patterns
@claude_src/novel/utils/state-manager.md
@claude_src/novel/schemas/story_state.schema.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create epub-generator skill</name>
  <files>claude_src/novel/skills/epub-generator.md</files>
  <action>
Create a skill document that provides EPUB generation operations using Pandoc.

**Structure:**
1. Overview - Purpose and Pandoc dependency
2. Prerequisites - Pandoc installation check and instructions
3. Metadata Preparation - How to create/update metadata.yaml from canon/premise.md
4. Scene Compilation - Ordering scenes by chapter/scene number
5. EPUB Generation - Pandoc command with all options
6. Validation (Optional) - epubcheck if available
7. Output Location - draft/compiled/novel.epub

**Prerequisites Section:**
```bash
# Check Pandoc installation
if ! command -v pandoc &> /dev/null; then
  echo "ERROR: Pandoc not installed"
  echo "Install: sudo apt-get install pandoc (Debian/Ubuntu)"
  echo "Install: brew install pandoc (macOS)"
  exit 1
fi
pandoc --version
```

**Metadata Preparation Section:**
- Start from template at claude_src/novel/templates/epub/metadata.yaml
- Extract title and author from canon/premise.md (look for "Title:" and "Author:" lines)
- Set language based on style_state.json or default to "en"
- Generate UUID for identifier if not already set
- Optionally include cover-image if images/cover.png exists

**Scene Compilation Section:**
- Read story_state.json scene_index
- Filter to scenes with status == "approved" (or "drafted" if --include-drafts flag)
- Sort by (chapter, scene) tuple for reading order
- Build file list: `draft/scenes/ch01_s01.md draft/scenes/ch01_s02.md ...`

**EPUB Generation Section:**
```bash
pandoc \
  draft/compiled/metadata.yaml \
  ${SCENE_FILES} \
  --toc \
  --toc-depth=2 \
  --epub-chapter-level=1 \
  --css=draft/compiled/epub.css \
  -o draft/compiled/novel.epub
```

**Error Handling:**
- No approved scenes: Warn and offer --include-drafts option
- Pandoc not installed: Clear installation instructions
- Missing metadata fields: Use sensible defaults
- Scene file missing: Skip with warning, continue compilation

Follow existing skill document patterns (state-manager.md, git-integration.md).
  </action>
  <verify>
File exists at claude_src/novel/skills/epub-generator.md with 150+ lines.
Contains "pandoc" command reference.
Contains "scene_index" reference for scene ordering.
Contains "--toc" option for table of contents.
Contains metadata.yaml reference.
  </verify>
  <done>
epub-generator.md skill provides complete Pandoc-based EPUB workflow with metadata, scene ordering, and error handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create EPUB templates (metadata.yaml and epub.css)</name>
  <files>claude_src/novel/templates/epub/metadata.yaml, claude_src/novel/templates/epub/epub.css</files>
  <action>
**Create metadata.yaml template:**

```yaml
---
# EPUB Metadata Template
# Edit this file before running /novel:publish
# Fields marked [REQUIRED] must be set

title:
  - type: main
    text: "[REQUIRED] Your Novel Title"
  - type: subtitle
    text: ""  # Optional subtitle

creator:
  - role: author
    text: "[REQUIRED] Author Name"

# Auto-generated if not set
identifier:
  - scheme: UUID
    text: ""

# Language code (ko, en, ja, zh, etc.)
language: ko

# Copyright notice
rights: "Copyright [YEAR] [Author Name]. All Rights Reserved."

# Publication date (YYYY-MM-DD)
date: ""

# Cover image path (relative to project root)
# Recommended size: 1000x1500 pixels
cover-image: ""

# Book description/blurb for e-reader stores
description: |
  [Add your book description here]

# Genre/category tags
subject:
  - Fiction

# Publisher name
publisher: "Self-Published"

# Custom CSS file
css: "epub.css"
---
```

**Create epub.css:**

```css
/* EPUB Default Stylesheet */
/* Customize for your novel's visual style */

/* Base typography */
body {
  font-family: Georgia, "Times New Roman", serif;
  font-size: 1em;
  line-height: 1.6;
  margin: 1em;
  text-align: justify;
}

/* Chapter headings */
h1 {
  font-size: 1.8em;
  font-weight: bold;
  text-align: center;
  margin-top: 2em;
  margin-bottom: 1em;
  page-break-before: always;
}

h2 {
  font-size: 1.4em;
  font-weight: bold;
  margin-top: 1.5em;
  margin-bottom: 0.5em;
}

/* Scene breaks */
hr {
  border: none;
  text-align: center;
  margin: 2em auto;
}

hr::before {
  content: "* * *";
  color: #666;
}

/* Paragraphs */
p {
  margin: 0;
  text-indent: 1.5em;
}

p:first-of-type,
h1 + p,
h2 + p,
hr + p {
  text-indent: 0;
}

/* Blockquotes (for internal monologue, letters, etc.) */
blockquote {
  font-style: italic;
  margin: 1em 2em;
  padding-left: 1em;
  border-left: 2px solid #ccc;
}

/* Emphasis */
em {
  font-style: italic;
}

strong {
  font-weight: bold;
}

/* Diary entry date headers */
.diary-date {
  font-style: italic;
  text-align: center;
  margin: 1em 0;
}

/* Korean text optimization */
:lang(ko) {
  word-break: keep-all;
  line-height: 1.8;
}
```

Both files should be created in claude_src/novel/templates/epub/ directory.
  </action>
  <verify>
File exists at claude_src/novel/templates/epub/metadata.yaml.
Contains "title:" field.
Contains "creator:" field with "author" role.
Contains "language:" field.

File exists at claude_src/novel/templates/epub/epub.css.
Contains "body" selector.
Contains "h1" selector for chapter headings.
Contains ":lang(ko)" for Korean text support.
  </verify>
  <done>
EPUB templates created: metadata.yaml with Dublin Core fields, epub.css with novel-appropriate typography.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create compiled directory template</name>
  <files>claude_src/novel/templates/directories/draft/compiled/README.md</files>
  <action>
Create a README.md for the draft/compiled/ directory:

```markdown
# Compiled Output Directory

This directory contains the final compiled manuscript and EPUB exports.

## Contents

| File | Purpose |
|------|---------|
| `metadata.yaml` | EPUB metadata (title, author, description) |
| `epub.css` | EPUB styling (typography, layout) |
| `novel.epub` | Generated EPUB file |

## Workflow

1. **Prepare metadata:** Copy and edit `metadata.yaml` from templates
2. **Run /novel:publish:** Compiles approved scenes into EPUB
3. **Verify output:** Open `novel.epub` in an e-reader app

## Metadata Source

The metadata.yaml file is initialized from `canon/premise.md` when you run `/novel:publish`. You can edit it manually for finer control.

## Regeneration

Running `/novel:publish` will regenerate `novel.epub`. Previous versions are not automatically backed up - use `draft/versions/` for historical copies.

## Requirements

- Pandoc must be installed (`pandoc --version` to check)
- At least one approved scene in story_state.json

## Files

- **metadata.yaml** - Edit before publishing for accurate book info
- **epub.css** - Customize typography and layout
- **novel.epub** - Final output (overwritten each publish)

---
*Generated by Novel Engine*
*See claude_src/novel/skills/epub-generator.md for details*
```

Ensure the directory structure is created: claude_src/novel/templates/directories/draft/compiled/
  </action>
  <verify>
File exists at claude_src/novel/templates/directories/draft/compiled/README.md.
Contains "metadata.yaml" reference.
Contains "epub.css" reference.
Contains "Pandoc" installation note.
  </verify>
  <done>
draft/compiled/README.md template documents the EPUB compilation output directory.
  </done>
</task>

</tasks>

<verification>
All files exist with required content:
1. epub-generator.md: 150+ lines with Pandoc workflow
2. metadata.yaml: Contains title, creator, language fields
3. epub.css: Contains body, h1, Korean language support
4. draft/compiled/README.md: Documents output directory

Templates follow project conventions and are ready for /novel:publish command.
</verification>

<success_criteria>
- [ ] epub-generator.md skill documents complete Pandoc EPUB workflow
- [ ] metadata.yaml template provides Dublin Core fields with clear instructions
- [ ] epub.css provides novel-appropriate default styling
- [ ] draft/compiled/README.md documents the output directory
- [ ] All templates follow existing project patterns
</success_criteria>

<output>
After completion, create `.planning/phases/06-advanced-features/06-02-SUMMARY.md`
</output>
