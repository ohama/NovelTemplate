---
phase: 06-advanced-features
plan: 03
type: execute
wave: 2
depends_on: ["06-02"]
files_modified:
  - claude_src/novel/commands/publish.md
  - .claude/commands/novel/publish.md
autonomous: false

must_haves:
  truths:
    - "User can run /novel:publish and receive compiled EPUB file"
    - "Command validates all scenes are approved before publishing"
    - "Command creates pre-publish snapshot for safety"
    - "EPUB output location is clearly reported to user"
    - "Missing metadata fields are detected with helpful guidance"
  artifacts:
    - path: "claude_src/novel/commands/publish.md"
      provides: "/novel:publish command implementation"
      min_lines: 400
    - path: ".claude/commands/novel/publish.md"
      provides: "Symlink for command discoverability"
  key_links:
    - from: "publish.md"
      to: "epub-generator.md"
      via: "skill reference"
      pattern: "epub-generator"
    - from: "publish.md"
      to: "version-manager.md"
      via: "pre-publish snapshot"
      pattern: "version-manager"
    - from: "publish.md"
      to: "story_state.json"
      via: "scene approval check"
      pattern: "scene_index"
---

<objective>
Implement the /novel:publish command that orchestrates the full publishing workflow: validation, snapshot, EPUB compilation, and output reporting.

Purpose: Provide a single command for writers to compile their approved manuscript into a distributable EPUB file with proper safety checks.
Output: /novel:publish command with validation, snapshot creation, EPUB generation, and success reporting.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-advanced-features/06-RESEARCH.md

# Dependencies from Plan 06-02
@claude_src/novel/skills/epub-generator.md
@claude_src/novel/skills/version-manager.md

# Existing command patterns
@claude_src/novel/commands/check.md
@claude_src/novel/commands/write.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /novel:publish command</name>
  <files>claude_src/novel/commands/publish.md</files>
  <action>
Create a comprehensive command document following the pattern of existing commands (check.md, write.md).

**Command Structure:**

```markdown
# /novel:publish

Compile approved scenes into a publishable EPUB file.

## Usage

```
/novel:publish [options]
```

### Options

| Option | Description |
|--------|-------------|
| `--include-drafts` | Include scenes with status "drafted" (not just "approved") |
| `--skip-snapshot` | Skip pre-publish snapshot (not recommended) |
| `--output PATH` | Custom output path (default: draft/compiled/novel.epub) |

## Prerequisites

- Pandoc installed (`pandoc --version`)
- At least one scene with status "approved" in story_state.json
- metadata.yaml exists in draft/compiled/ (or will be generated)

## Workflow

### Step 1: Validate Environment

1. Check Pandoc is installed
2. Read story_state.json
3. Verify project directories exist (draft/scenes/, draft/compiled/)

If Pandoc not found:
- Display installation instructions
- Exit with error

### Step 2: Validate Scenes

1. Load scene_index from story_state.json
2. Filter scenes by status:
   - Default: only "approved" scenes
   - With --include-drafts: "approved" + "drafted" scenes
3. Check at least one scene matches filter

If no scenes match:
- Display helpful message about running /novel:check first
- Exit with error

### Step 3: Validate Metadata

1. Check if draft/compiled/metadata.yaml exists
2. If not exists:
   - Copy from claude_src/novel/templates/epub/metadata.yaml
   - Extract title/author from canon/premise.md if available
   - Generate UUID for identifier
3. Validate required fields (title, creator):
   - If missing, warn but continue with placeholders

Display metadata summary:
- Title
- Author
- Language
- Scene count

### Step 4: Create Pre-Publish Snapshot

1. Reference version-manager.md skill
2. Create snapshot with trigger="pre_publish"
3. Update story_state.json versions.snapshots array
4. Display snapshot ID for reference

If --skip-snapshot:
- Skip this step with warning

### Step 5: Copy EPUB CSS

1. Check if draft/compiled/epub.css exists
2. If not exists:
   - Copy from claude_src/novel/templates/epub/epub.css
3. CSS is now available for Pandoc

### Step 6: Compile Scene List

1. Sort scenes by (chapter, scene) for reading order
2. Build file list for Pandoc:
   ```
   draft/scenes/ch01_s01.md draft/scenes/ch01_s02.md ...
   ```
3. Verify each file exists
4. Display compilation order

### Step 7: Generate EPUB

1. Reference epub-generator.md skill
2. Run Pandoc command:
   ```bash
   pandoc \
     draft/compiled/metadata.yaml \
     [scene files in order] \
     --toc \
     --toc-depth=2 \
     --epub-chapter-level=1 \
     --css=draft/compiled/epub.css \
     -o draft/compiled/novel.epub
   ```
3. Capture output/errors

If Pandoc fails:
- Display error message
- Suggest checking scene Markdown validity
- Exit with error

### Step 8: Update State

1. Update story_state.json:
   - Set versions.last_publish to current timestamp
   - Increment publish_count (add field if not exists)
2. Write state file

### Step 9: Display Success Report

```
========================================
PUBLISH COMPLETE
========================================

Output: draft/compiled/novel.epub
Size:   [file size]
Scenes: [count] scenes in [chapters] chapters

Snapshot: [snapshot_id] (pre-publish backup)

Metadata:
  Title:  [title]
  Author: [author]

Next Steps:
  - Open novel.epub in an e-reader to verify
  - Edit draft/compiled/metadata.yaml to update book info
  - Re-run /novel:publish to regenerate

========================================
```

## Error Handling

| Error | Recovery |
|-------|----------|
| Pandoc not installed | Display install instructions |
| No approved scenes | Suggest running /novel:check |
| Scene file missing | Skip scene, warn, continue if others exist |
| Metadata incomplete | Use placeholders, warn user |
| Pandoc compilation fails | Show error, suggest checking Markdown |

## Examples

### Basic publish (approved scenes only)
```
/novel:publish
```

### Include draft scenes for preview
```
/novel:publish --include-drafts
```

### Custom output location
```
/novel:publish --output ~/Desktop/my-novel.epub
```
```

The command document should be 400+ lines following the detailed pattern of check.md.
  </action>
  <verify>
File exists at claude_src/novel/commands/publish.md with 400+ lines.
Contains "Pandoc" reference.
Contains "metadata.yaml" reference.
Contains "version-manager" or "snapshot" reference.
Contains "epub-generator" reference.
Contains step-by-step workflow (Step 1 through Step 9).
  </verify>
  <done>
/novel:publish command document provides complete publishing workflow with validation, snapshot, EPUB generation, and reporting.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create command symlink</name>
  <files>.claude/commands/novel/publish.md</files>
  <action>
Create a symlink file that points to the main command implementation.

Create the file at `.claude/commands/novel/publish.md` with content:

```markdown
<!--
This is a symlink to the canonical command implementation.
Edit the source file, not this file.
Source: claude_src/novel/commands/publish.md
-->

@claude_src/novel/commands/publish.md
```

This follows the pattern established in Phase 1 (01-02) for command discoverability via Claude Code's command system while maintaining single source of truth.

Verify the .claude/commands/novel/ directory exists (should from Phase 1).
  </action>
  <verify>
File exists at .claude/commands/novel/publish.md.
Contains reference to claude_src/novel/commands/publish.md.
  </verify>
  <done>
Command symlink created for /novel:publish discoverability.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete /novel:publish command with EPUB export workflow</what-built>
  <how-to-verify>
1. Review the command at claude_src/novel/commands/publish.md
2. Verify it follows existing command patterns (compare to check.md, write.md)
3. Confirm workflow steps are complete:
   - Environment validation (Pandoc check)
   - Scene validation (approval status)
   - Metadata handling
   - Pre-publish snapshot
   - Pandoc EPUB generation
   - Success reporting
4. Verify symlink exists at .claude/commands/novel/publish.md
5. Confirm the command references:
   - epub-generator.md skill
   - version-manager.md skill
   - story_state.json for scene status
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to address</resume-signal>
</task>

</tasks>

<verification>
1. Command exists at claude_src/novel/commands/publish.md (400+ lines)
2. Symlink exists at .claude/commands/novel/publish.md
3. Command references epub-generator.md and version-manager.md skills
4. Command includes all 9 workflow steps
5. Error handling covers all common failure cases
</verification>

<success_criteria>
- [ ] /novel:publish command document is complete with 400+ lines
- [ ] Command follows existing patterns from check.md and write.md
- [ ] Workflow includes validation, snapshot, EPUB generation, state update
- [ ] Symlink created for command discoverability
- [ ] Human verification confirms command is production-ready
</success_criteria>

<output>
After completion, create `.planning/phases/06-advanced-features/06-03-SUMMARY.md`
</output>
