---
phase: 01
plan: 03
name: /novel:status Command & Git Integration
wave: 2
depends_on: [01-02]
files_modified:
  - claude_src/novel/commands/status.md
  - claude_src/novel/skills/git-integration.md
  - .claude/commands/novel/status.md
autonomous: true
---

# Plan 01-03: /novel:status Command & Git Integration

## Objective

Build the `/novel:status` command for progress reporting and implement git auto-commit integration for canon changes and scene completion. This provides visibility into project state and ensures automatic version control of important milestones.

**User Experience Goal:** User can check project status at any time and get clear guidance on next steps.

---

## Tasks

<task id="01-03-01">
<description>
Create the /novel:status command skill with comprehensive reporting.

Build status.md following Claude Code command pattern:
- YAML frontmatter with allowed-tools
- <role> section: Status Reporter Agent persona
- <commands> section: Usage table
- <execution> section: Sequential steps for status gathering
- <examples> section: Example status outputs
- <edge_cases> section: Not initialized, corrupted state

Execution steps (research lines 84-90):
1. Check if project initialized (canon/ exists)
2. Load all 4 state files (story_state, character_state, timeline_state, style_state)
3. Parse progress indicators (outline status, draft status, word count)
4. Identify current position (chapter, scene)
5. Check for open issues (pending threads, validation warnings)
6. Display formatted status report
7. Suggest next action based on current state

Status report should show:
- Project title and format
- Progress: Outline (not_started/in_progress/complete)
- Progress: Beats (not_started/in_progress/complete)
- Progress: Draft (not_started/in_progress/complete)
- Current position: Chapter X, Scene Y
- Scenes completed: N / M
- Total word count: XXXX words
- Open plot threads: N
- Next suggested action: /novel:outline (if not done) or /novel:write (if ready)

For Phase 1 (before outline implemented):
- Should show "No outline yet" and suggest user define canon first
</description>

<files>
- claude_src/novel/commands/status.md
</files>

<verification>
1. status.md exists with valid YAML frontmatter
2. YAML includes allowed-tools: [Read, Bash, Glob]
3. <role> section defines Status Reporter persona
4. <commands> table documents /novel:status
5. <execution> has 7 steps for status gathering
6. Step 1 checks if initialized (canon/ exists)
7. Step 2 loads all state files using state-manager skill
8. Step 3 parses progress fields from story_state.json
9. Step 4 identifies current chapter/scene
10. Step 6 formats output clearly (sections, headers, bullet points)
11. Step 7 suggests next action based on state
12. <edge_cases> handles: not initialized, corrupted state, missing files
13. <examples> shows status output for: new project, in-progress project
</verification>
</task>

<task id="01-03-02">
<description>
Create git-integration skill with auto-commit patterns.

Build git-integration.md as a reusable skill that other commands invoke:
- Documents when to auto-commit (after init, canon changes, scene completion)
- Documents when NOT to auto-commit (every state update, planning phases, errors)
- Provides commit message templates
- Handles git not available (graceful degradation)
- Follows GSD atomic commit pattern (research lines 982-1001)
- Never uses force push or destructive operations
- Always uses heredoc for multi-line commit messages
- Always includes Co-Authored-By tag

Functions to document:
- commit_canon_changes(): Detect changed canon files, commit with descriptive message
- commit_scene_completion(scene_id): Commit completed scene + updated state
- commit_init(title): Initial project commit
- check_git_available(): Test if git command exists

Configuration check:
- Read story_state.json → project.git_integration.enabled
- If false, skip all git operations silently
</description>

<files>
- claude_src/novel/skills/git-integration.md
</files>

<verification>
1. git-integration.md exists with YAML frontmatter
2. Documents 5 auto-commit scenarios (init, canon changes, outline, scene, revision)
3. Documents 3 non-commit scenarios (state updates, planning, errors)
4. Includes commit_canon_changes() function with detection logic
5. Includes commit_scene_completion() function
6. Includes commit_init() function
7. Includes check_git_available() function
8. All commit messages use heredoc format (cat <<'EOF')
9. All commit messages include Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
10. Documents configuration check (git_integration.enabled in story_state.json)
11. Documents graceful degradation (continue if git fails)
12. Includes example bash code for each function
</verification>
</task>

<task id="01-03-03">
<description>
Add git integration to /novel:init command.

Update init.md to call git-integration skill after creating project:
- Step 7 (or new step): Initialize git repository
- Check if git available using check_git_available()
- If git not available: warn but continue
- If .git already exists: skip git init
- Create .gitignore from template
- Stage all created files (canon/, state/, beats/, draft/, .gitignore)
- Commit using commit_init(title) function
- Check story_state.json for git_integration.enabled (add to schema if needed)

Update story_state.default.json to include git_integration config:
```json
"project": {
  "git_integration": {
    "enabled": true,
    "auto_commit_canon": true,
    "auto_commit_scenes": true,
    "auto_commit_state": false
  }
}
```
</description>

<files>
- claude_src/novel/commands/init.md (update)
- claude_src/novel/schemas/story_state.default.json (update)
</files>

<verification>
1. init.md includes git initialization step
2. Step calls check_git_available() before attempting git operations
3. Step creates .gitignore from template
4. Step calls commit_init(title) after all files created
5. Handles git not available gracefully (warns, continues)
6. Handles .git already exists (skips git init)
7. story_state.default.json includes git_integration object
8. git_integration has enabled, auto_commit_canon, auto_commit_scenes flags
9. Test: /novel:init creates .git directory and initial commit
10. Test: /novel:init in existing git repo doesn't re-init
</verification>
</task>

<task id="01-03-04">
<description>
Implement canon change detection for auto-commit.

Create mechanism to detect when user manually edits canon files:
- This will be invoked by future commands before they read canon
- Use git status --porcelain canon/ to detect changes
- If changes detected and git_integration.auto_commit_canon=true
- Commit changes with descriptive message based on which files changed

Since there's no continuous daemon, this check happens:
- Before /novel:outline runs (Phase 2)
- Before /novel:write runs (Phase 4)
- When /novel:status runs (opportunistic commit)

Document this pattern in git-integration.md.
</description>

<files>
- claude_src/novel/skills/git-integration.md (update)
</files>

<verification>
1. git-integration.md includes commit_canon_changes() function
2. Function uses git status --porcelain canon/ to detect changes
3. Function identifies which canon file changed (premise, characters, etc.)
4. Function generates specific commit message (e.g., "Update character profiles")
5. Function checks git_integration.auto_commit_canon before committing
6. Function stages only canon/ directory (git add canon/)
7. Function uses heredoc for commit message with Co-Authored-By tag
8. Documents when this function should be called (before outline, write, status)
9. Includes example bash implementation
</verification>
</task>

<task id="01-03-05">
<description>
Create symlink/copy for status command to make it discoverable.

Make /novel:status accessible to users:
- .claude/commands/novel/status.md (symlink to claude_src/novel/commands/status.md)
</description>

<files>
- .claude/commands/novel/status.md (symlink or copy)
</files>

<verification>
1. .claude/commands/novel/status.md exists
2. File points to claude_src/novel/commands/status.md
3. Running /novel:status from Claude Code CLI works
4. Command appears in skill list
</verification>
</task>

<task id="01-03-06">
<description>
Test /novel:status in various project states.

Test scenarios:
1. Fresh project (just initialized)
   - Should show: "No outline yet", "0 scenes written", suggest next steps
2. Non-initialized directory
   - Should error: "Not a novel project. Run /novel:init first."
3. Project with corrupted state
   - Should warn: "State file corrupted", suggest recovery
4. Status check after canon edit
   - Should auto-commit canon changes (if git enabled)

Test git integration:
1. Initialize project, verify initial commit created
2. Edit canon/premise.md manually
3. Run /novel:status
4. Verify commit created for premise changes
5. Check commit message includes Co-Authored-By tag
</description>

<files>
- (No new files, testing existing implementation)
</files>

<verification>
1. Test 1 - Fresh project:
   - /novel:init "Test" && /novel:status
   - Output shows "No outline yet"
   - Suggests editing canon files or running /novel:outline (when available)
2. Test 2 - Not initialized:
   - mkdir /tmp/not-novel && cd /tmp/not-novel
   - /novel:status
   - Error message clear and actionable
3. Test 3 - Corrupted state:
   - echo "invalid json" > state/story_state.json
   - /novel:status
   - Shows warning, suggests recovery
4. Test 4 - Canon edit:
   - Edit canon/premise.md
   - /novel:status
   - git log shows new commit for premise update
5. Verify commit message format:
   - git log -1 --pretty=full
   - Shows Co-Authored-By tag
</verification>
</task>

---

## must_haves

This plan MUST deliver:

1. **/novel:status Command:** Shows project progress, current position, next action
2. **Git Integration Skill:** Reusable auto-commit logic
3. **Auto-Commit on Init:** Initial commit after /novel:init
4. **Auto-Commit on Canon Changes:** Detects and commits user edits
5. **Configuration Support:** git_integration flags in story_state.json
6. **Graceful Degradation:** Works even if git not available
7. **Clear Status Output:** User understands project state at a glance

**User Experience:** User edits canon/premise.md, runs /novel:status, sees commit created automatically.

---

## Verification Criteria

### Pass Criteria

✓ status.md exists with 7 execution steps
✓ /novel:status shows progress for all 3 phases (outline, beats, draft)
✓ /novel:status shows current chapter/scene position
✓ /novel:status suggests next action based on state
✓ /novel:status handles not initialized error gracefully
✓ git-integration.md documents all commit scenarios
✓ git-integration.md includes all 4 functions
✓ /novel:init creates initial git commit with all files
✓ Canon changes detected and auto-committed when status runs
✓ Commit messages include Co-Authored-By tag
✓ Git operations skip gracefully if git not available
✓ story_state.json includes git_integration config

### Verification Commands

```bash
# Test status in fresh project
/novel:init "Test Novel"
/novel:status
# Should show: "No outline yet", "0 scenes written"

# Test git integration
git log -1 --oneline
# Should show: "Initialize novel project: Test Novel"

# Test canon auto-commit
echo "Updated premise" >> canon/premise.md
/novel:status
git log -1 --oneline
# Should show: "Update premise"

# Verify commit format
git log -1 --pretty=full | grep "Co-Authored-By"
# Should find: Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>

# Test not initialized
mkdir /tmp/test-no-init && cd /tmp/test-no-init
/novel:status
# Should error with helpful message
```

### Fail Criteria

✗ /novel:status fails on fresh project
✗ Status output unclear or missing sections
✗ No next action suggested
✗ Git integration missing or incomplete
✗ /novel:init doesn't create git commit
✗ Canon changes not detected
✗ Commit messages missing Co-Authored-By tag
✗ Git failure blocks command execution (should warn and continue)

---

## Dependencies

**Depends on:**
- Plan 01-01 (needs state schemas and state-manager)
- Plan 01-02 (needs /novel:init to create projects to report on)

**Enables:**
- Phase 02 (Planning Pipeline) - can check project status
- All future commands - use git-integration skill for commits

---

## Notes

- Status command is the user's window into project state—make it clear
- Git integration is optional but highly valuable—default to enabled
- Auto-commit philosophy: Commit milestones, not every state change
- Follow GSD pattern: atomic commits with descriptive messages
- Graceful degradation is critical—don't break workflow if git missing
- Co-Authored-By tag gives credit to AI assistance
- Status should suggest next action to guide workflow
- For Phase 1, "next action" is limited (no outline command yet)
- This completes the foundation—Phase 2 can now build on solid ground
