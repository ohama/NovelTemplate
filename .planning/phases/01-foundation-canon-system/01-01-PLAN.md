---
phase: 01
plan: 01
name: Directory Structure & State Initialization
wave: 1
depends_on: []
files_modified:
  - claude_src/novel/schemas/story_state.schema.json
  - claude_src/novel/schemas/character_state.schema.json
  - claude_src/novel/schemas/timeline_state.schema.json
  - claude_src/novel/schemas/style_state.schema.json
  - claude_src/novel/utils/state-manager.md
autonomous: true
---

# Plan 01-01: Directory Structure & State Initialization

## Objective

Establish the foundational directory structure (canon/, state/, beats/, draft/) and implement JSON state management with validated schemas for story_state, character_state, timeline_state, and style_state. This plan creates the persistent storage layer that all other phases depend on.

**Critical Success Factor:** State schemas must be correct now—changing them later breaks all agents.

---

## Tasks

<task id="01-01-01">
<description>
Create JSON schema files for all four state types with strict validation rules.

Each schema must:
- Use JSON Schema Draft 2020-12
- Include schema_version field for future migrations
- Define required fields with appropriate types
- Use enums for constrained values
- Support extensibility (diary format adds fields without breaking base)
- Include descriptions for all fields
- Validate date/time formats using JSON Schema patterns
</description>

<files>
- claude_src/novel/schemas/story_state.schema.json
- claude_src/novel/schemas/character_state.schema.json
- claude_src/novel/schemas/timeline_state.schema.json
- claude_src/novel/schemas/style_state.schema.json
</files>

<verification>
1. All 4 schema files exist in claude_src/novel/schemas/
2. Each schema is valid JSON (test with `jq empty [file]`)
3. Each schema includes "$schema", "schema_version", and appropriate "required" fields
4. story_state includes: project, progress, current, open_threads, scene_index
5. character_state includes: characters, relationships, voice_notes, arc_notes
6. timeline_state includes: anchors, events, constraints
7. style_state includes: pov, tense, voice, forbidden_phrases, cliche_watchlist
8. Enums match research specifications exactly
</verification>
</task>

<task id="01-01-02">
<description>
Create default/initial state files that pass schema validation.

Generate template state files with valid default values that can be used by /novel:init:
- story_state: Empty project with format="chapter", progress="not_started", empty scene_index
- character_state: Empty characters object, empty relationships array
- timeline_state: Empty anchors/events/constraints arrays
- style_state: Sensible defaults (pov="third_limited", tense="past", voice="clean")
- All files include schema_version="1.0"
- All dates in ISO 8601 format
- All required fields populated
</description>

<files>
- claude_src/novel/schemas/story_state.default.json
- claude_src/novel/schemas/character_state.default.json
- claude_src/novel/schemas/timeline_state.default.json
- claude_src/novel/schemas/style_state.default.json
</files>

<verification>
1. All 4 default state files exist
2. Each file passes validation against its schema (manual test with schema validator)
3. All required fields are present with valid values
4. No placeholder/null values in required fields
5. JSON is pretty-printed (2-space indent) for readability
6. Dates use ISO 8601 format (YYYY-MM-DD or YYYY-MM-DDTHH:mm:ss)
</verification>
</task>

<task id="01-01-03">
<description>
Create state-manager skill that provides state loading/saving utilities.

This reusable skill should be invoked by other commands to handle state file I/O:
- Load state: Read JSON file, parse, validate against schema (graceful fallback on error)
- Save state: Validate against schema before write, pretty-print JSON
- Update state: Load → modify → validate → save pattern
- Handle missing files (return default state)
- Handle corrupted JSON (use last git commit version if available)
- Log warnings for validation errors without blocking

Design as a skill (not a library) since this is Claude Code, not a codebase with imports.
</description>

<files>
- claude_src/novel/utils/state-manager.md
</files>

<verification>
1. state-manager.md exists with YAML frontmatter
2. Includes functions for: load_state(type), save_state(type, data), update_state(type, modifications)
3. Documents error handling strategy (graceful degradation)
4. Provides example usage for each function
5. Specifies validation approach (jq validation or inline checks)
6. Includes rollback strategy if validation fails after write
7. Documents state file locations (state/*.json)
</verification>
</task>

<task id="01-01-04">
<description>
Create directory scaffolding templates that /novel:init will use.

Define the exact structure and README files for each directory:
- canon/ → README explaining immutable truth, user-editable
- state/ → README explaining mutable progress, machine-managed
- beats/ → README explaining story structure layer
- draft/ → README with subdirectories (scenes/, chapters/, versions/)
- Each README includes purpose, who edits it, and examples
- draft/scenes/.gitkeep to ensure directory commits
- draft/chapters/.gitkeep to ensure directory commits
</description>

<files>
- claude_src/novel/templates/directories/canon/README.md
- claude_src/novel/templates/directories/state/README.md
- claude_src/novel/templates/directories/beats/README.md
- claude_src/novel/templates/directories/draft/README.md
- claude_src/novel/templates/directories/draft/scenes/.gitkeep
- claude_src/novel/templates/directories/draft/chapters/.gitkeep
</files>

<verification>
1. All README files exist and contain clear purpose statements
2. READMEs explain state/canon boundary correctly
3. draft/README documents subdirectory structure (scenes/, chapters/, versions/)
4. .gitkeep files present for empty directories
5. All files use Markdown format with clear headers
6. Examples show expected file types in each directory
</verification>
</task>

<task id="01-01-05">
<description>
Validate all schemas and defaults pass JSON Schema compliance testing.

Create a simple validation test script that:
- Loads each schema file
- Loads each default state file
- Validates defaults against schemas
- Reports pass/fail for each combination
- Tests invalid data (should fail validation)
- Ensures all enum values are valid
- Checks date format patterns work

This can be a bash script using jq or a simple Node.js script if available.
</description>

<files>
- claude_src/novel/schemas/validate-schemas.sh
</files>

<verification>
1. validate-schemas.sh exists and is executable
2. Script validates all 4 default files against schemas
3. All validations pass (exit code 0)
4. Script outputs clear pass/fail messages
5. Test with deliberately invalid data confirms validation catches errors
6. Can run with: `bash claude_src/novel/schemas/validate-schemas.sh`
</verification>
</task>

---

## must_haves

This plan MUST deliver:

1. **Valid JSON Schemas:** All 4 schema files exist and define complete, extensible state structure
2. **Default State Files:** All 4 default state files pass schema validation
3. **State Manager Skill:** Reusable skill for state I/O with error handling
4. **Directory Templates:** Complete directory structure with READMEs
5. **Validation Passing:** All schemas validate against defaults successfully

**Critical:** These schemas are the contract for all future phases. They must be complete and correct.

---

## Verification Criteria

### Pass Criteria

✓ All 4 schema files exist in `claude_src/novel/schemas/`
✓ All 4 default state files exist and contain valid JSON
✓ `validate-schemas.sh` runs and reports all validations pass
✓ state-manager.md exists with load/save functions documented
✓ All 4 directory READMEs exist with clear purpose statements
✓ Directory structure matches research spec exactly:
  - canon/
  - state/
  - beats/
  - draft/scenes/
  - draft/chapters/

### Verification Commands

```bash
# Validate JSON syntax
jq empty claude_src/novel/schemas/*.json

# Run validation tests
bash claude_src/novel/schemas/validate-schemas.sh

# Check directory templates exist
ls claude_src/novel/templates/directories/*/README.md

# Verify schema structure
jq '.properties | keys' claude_src/novel/schemas/story_state.schema.json
# Should output: ["project", "progress", "current", "open_threads", "resolved_threads", "scene_index", "diary_metadata"]
```

### Fail Criteria

✗ Any schema file is invalid JSON
✗ Any default state file fails schema validation
✗ Missing required fields in schemas
✗ Enum values don't match research specifications
✗ state-manager.md missing or incomplete
✗ Directory READMEs missing or unclear

---

## Dependencies

**Depends on:** None (Wave 1 - runs independently)

**Enables:**
- Plan 01-02 (/novel:init) - needs schemas and directory templates
- Plan 01-03 (/novel:status) - needs state loading utilities

---

## Notes

- This is foundational work—quality over speed
- Schemas should match research document exactly (lines 109-473)
- Default state files must demonstrate proper structure for /novel:init
- state-manager.md is a skill (Markdown), not code (this is Claude Code, not a codebase)
- Validation script ensures schemas are production-ready
- All JSON files should be pretty-printed (2-space indent) for human readability
