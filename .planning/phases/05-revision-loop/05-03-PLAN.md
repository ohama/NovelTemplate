---
phase: 05-revision-loop
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Running /novel:check produces editorial letter with 3-5 priorities"
    - "Quality gate approves scenes with ≤2 MAJOR issues, rejects scenes with CRITICAL issues"
    - "story_state.json shows revision_count and revision_history for checked scenes"
    - "Scene status updates to 'approved' or 'needs_revision' based on gate decision"
    - "User can see full revision workflow from check → feedback → decision → tracking"
  artifacts:
    - path: "check_reports/[timestamp]/editorial_letter.md"
      provides: "Editorial feedback synthesizing checker findings"
      min_lines: 50
    - path: "check_reports/[timestamp]/quality_decision.json"
      provides: "Quality gate approval decisions"
      contains: "scene_decisions"
    - path: "state/story_state.json"
      provides: "Updated state with revision history"
      contains: "revision_history"
  key_links:
    - from: "/novel:check command"
      to: "editorial_letter.md"
      via: "Editor agent spawned"
      pattern: "Editorial feedback available"
    - from: "/novel:check command"
      to: "quality_decision.json"
      via: "Quality gate agent spawned"
      pattern: "Quality gate decision"
    - from: "/novel:check command"
      to: "story_state.json"
      via: "State update with revision cycle"
      pattern: "revision_history.*append"
---

<objective>
Verify complete revision loop workflow end-to-end: checker execution → editorial synthesis → quality gate decision → state tracking.

Purpose: Confirm all Phase 5 components integrate correctly and produce expected outputs (editorial letters, quality decisions, revision history).

Output: Human-verified working revision loop ready for iterative drafting improvement cycles.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-revision-loop/05-RESEARCH.md
@.planning/phases/05-revision-loop/05-01-SUMMARY.md
@.planning/phases/05-revision-loop/05-02-SUMMARY.md
@claude_src/novel/commands/check.md
@claude_src/novel/agents/novel-editor.md
@claude_src/novel/agents/novel-quality-gate.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete revision loop pipeline integrating:
- 5 quality checker agents (Phase 4)
- novel-editor agent synthesizing findings (Phase 5 Plan 01)
- novel-quality-gate agent making approval decisions (Phase 5 Plan 01)
- Extended /novel:check command orchestrating pipeline (Phase 5 Plan 02)
- story_state.json revision tracking (Phase 5 Plan 02)
  </what-built>

  <how-to-verify>
**Prerequisites:**
Ensure you have a novel project with drafted scenes. If not, create test project:
```bash
cd /tmp
mkdir novel-test && cd novel-test
# Run /novel:init "Test Novel"
# Run /novel:outline (will generate basic structure)
# Run /novel:write (draft 2-3 scenes)
```

**Verification Steps:**

1. **Run quality check with revision loop:**
   ```
   /novel:check
   ```

2. **Verify checker execution (Phase 4 baseline):**
   - Console shows "Running in parallel: Canon Checker, Timeline Keeper, Voice Coach, Pacing Analyzer, Tension Monitor"
   - Check reports directory created: `ls -la check_reports/`
   - Individual checker JSONs exist: `ls check_reports/[latest-timestamp]/*.json`
   - Consolidated summary exists: `cat check_reports/[latest-timestamp]/summary.md`

3. **Verify editorial letter generation (NEW):**
   - Editorial letter exists: `ls check_reports/[latest-timestamp]/editorial_letter.md`
   - Open editorial letter: `cat check_reports/[latest-timestamp]/editorial_letter.md`
   - Confirm structure:
     - [ ] Has "What Works Well" section (1-3 positive items)
     - [ ] Has "Must Fix" section (CRITICAL issues if any)
     - [ ] Has "Should Fix" section (high-impact MAJOR issues)
     - [ ] Has "Could Fix" section (MINOR issues and polish)
     - [ ] Limited to 3-5 total priorities (not overwhelming)
     - [ ] Each priority includes scene references and fix strategy
     - [ ] Has "Revision Plan" with numbered steps
     - [ ] Has "Next Steps" with actionable guidance

4. **Verify quality gate decision (NEW):**
   - Quality decision JSON exists: `ls check_reports/[latest-timestamp]/quality_decision.json`
   - Open quality decision: `cat check_reports/[latest-timestamp]/quality_decision.json`
   - Confirm structure:
     - [ ] Has `overall_status` field (CRITICAL_ISSUES | NEEDS_REVISION | APPROVED)
     - [ ] Has `criteria_used` with thresholds (critical: 0, major: 2, minor: 999)
     - [ ] Has `scenes_evaluated`, `scenes_approved`, `scenes_need_revision` counts
     - [ ] Has `scene_decisions` array with per-scene verdicts
     - [ ] Each scene decision includes `decision`, `reason`, `blocking_issues`
     - [ ] Has `recommended_actions` array

5. **Verify state tracking (NEW):**
   - Read story state: `cat state/story_state.json`
   - For each checked scene in `scenes` array, confirm:
     - [ ] `status` field updated ("needs_revision" or "approved")
     - [ ] `revision_count` field exists and is ≥ 1
     - [ ] `revision_history` array has at least one entry
     - [ ] Latest revision history entry has:
       - `cycle` number matching revision_count
       - `timestamp` (ISO 8601 format)
       - `check_report` path to report directory
       - `issues_found` counts (critical, major, minor)
       - `decision` ("needs_revision" or "approved")
       - `blocking_issues` array (if needs_revision)
       - `editorial_focus` array
     - [ ] `last_check` timestamp updated
     - [ ] `approved_at` set (if status is "approved")

6. **Verify console output (EXTENDED):**
   - Console output includes (in addition to Phase 4 checker summary):
     - [ ] "QUALITY GATE DECISION" section
     - [ ] Shows overall status (NEEDS_REVISION or APPROVED)
     - [ ] Lists scenes needing revision with reasons
     - [ ] Shows "Editorial feedback available at: [path]"
     - [ ] Shows "Quality gate decision: [path]"

7. **Test revision cycle tracking:**
   - If any scenes need revision, fix one issue manually in draft/scenes/[scene].md
   - Run `/novel:check` again
   - Verify:
     - [ ] New check report directory created
     - [ ] `revision_count` incremented for modified scene
     - [ ] `revision_history` has two entries now
     - [ ] Second entry shows improved issue counts

8. **Test quality gate approval criteria:**
   - Check a scene with 0 CRITICAL and ≤2 MAJOR issues
   - Expected: status should be "approved"
   - Check a scene with any CRITICAL issue or >2 MAJOR issues
   - Expected: status should be "needs_revision"

**Expected Behavior:**

- /novel:check completes without errors
- All 5 checkers execute successfully
- Editorial letter synthesizes findings into 3-5 priorities
- Quality gate applies objective criteria (0 CRITICAL, 2 MAJOR max)
- story_state.json tracks revision cycles with full history
- Console output shows complete pipeline results

**Success Indicators:**

- Editorial letter is actionable (specific scenes, clear fix strategies)
- Quality decisions are objective (based on thresholds, not subjective)
- Revision history provides audit trail of improvement cycles
- User can see which scenes passed/failed and why
  </how-to-verify>

  <resume-signal>
Type one of:
- "approved" - Revision loop working correctly, all verifications passed
- "issues: [description]" - Problems found, describe what's broken
- "needs adjustment: [details]" - Minor fixes needed before approval
  </resume-signal>
</task>

</tasks>

<verification>
Checkpoint verification confirms:
- [ ] /novel:check executes complete pipeline (checkers → editor → quality gate → state update)
- [ ] editorial_letter.md generated with Must/Should/Could structure
- [ ] quality_decision.json contains scene-level approval decisions
- [ ] story_state.json revision_history tracks all check cycles
- [ ] Console output shows quality gate results and revision tracking
- [ ] Workflow supports iterative improvement (multiple check cycles tracked)
</verification>

<success_criteria>
- Human verification confirms revision loop functional
- Editorial letters provide actionable feedback (3-5 priorities, specific fixes)
- Quality gate applies objective criteria correctly (CRITICAL blocks, MAJOR threshold = 2)
- Revision history tracks improvements across cycles
- Phase 5 complete: revision loop integrated into /novel:check workflow
</success_criteria>

<output>
After completion, create `.planning/phases/05-revision-loop/05-03-SUMMARY.md`
</output>
