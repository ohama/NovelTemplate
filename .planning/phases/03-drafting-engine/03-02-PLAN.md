---
phase: 03-drafting-engine
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - claude_src/novel/commands/write.md
  - .claude/commands/novel/write.md
autonomous: false

must_haves:
  truths:
    - "User can run /novel:write and see next scene drafted"
    - "Command finds next planned scene from scene_index"
    - "Command spawns scene-writer agent with full context"
    - "Completed scene is auto-committed to git if available"
    - "User sees completion report with word count and status"
    - "Prose quality meets style_guide constraints"
  artifacts:
    - path: "claude_src/novel/commands/write.md"
      provides: "/novel:write command definition"
      min_lines: 100
      contains: "validation.*scene-writer.*git.*report"
    - path: ".claude/commands/novel/write.md"
      provides: "Symlink for command discoverability"
      links_to: "../../claude_src/novel/commands/write.md"
  key_links:
    - from: "write.md command"
      to: "scene-writer agent"
      via: "spawn agent with context"
      pattern: "scene-writer.*context"
    - from: "write.md command"
      to: "git-integration skill"
      via: "commit scene completion"
      pattern: "commit_scene_completion"
    - from: "write.md command"
      to: "story_state.json"
      via: "find next planned scene"
      pattern: "scene_index.*status.*planned"
---

<objective>
Build the /novel:write command that orchestrates scene drafting by spawning the scene-writer agent, handling git commits, and providing user feedback.

Purpose: This command is the primary user-facing interface for prose generation. It validates prerequisites, finds the next scene to draft, spawns the scene-writer agent with appropriate context, handles git commits for completed scenes, and reports progress to the user.

Output: A complete command definition with validation, orchestration, and error handling, plus a human verification checkpoint to ensure prose quality meets standards.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-drafting-engine/03-RESEARCH.md
@.planning/phases/03-drafting-engine/03-01-SUMMARY.md

# Prior command patterns
@claude_src/novel/commands/init.md
@claude_src/novel/commands/outline.md
@claude_src/novel/commands/status.md

# Dependencies
@claude_src/novel/agents/scene-writer.md
@claude_src/novel/skills/git-integration.md
@claude_src/novel/utils/state-manager.md
</context>

<tasks>

<task type="auto">
  <name>Create /novel:write command definition</name>
  <files>claude_src/novel/commands/write.md</files>
  <action>
Create /novel:write command following the established command pattern from init.md and outline.md.

**Command structure:**

1. **Frontmatter** (YAML):
   - name: write
   - description: Draft the next scene from beat specifications
   - version: 1.0

2. **Purpose section**:
   - User runs: `/novel:write`
   - Expected: Next planned scene is drafted to draft/scenes/chXX_sYY.md
   - State updated: scene_index status changes from "planned" to "drafted"
   - Git: Scene auto-committed if git available

3. **Prerequisites section**:
   - Project initialized (/novel:init completed)
   - Outline generated (/novel:outline completed)
   - At least one scene with status "planned" in scene_index
   - Canon files exist (style_guide.md, characters.md)

4. **Execution steps**:

   **Step 1: Validate Prerequisites**
   - Check state/story_state.json exists
   - Verify progress.beat_plan == "complete" (outline must be done)
   - Load scene_index from story_state.json
   - Find first scene with status == "planned"
   - If no planned scenes found:
     - Check if any scenes exist
     - If none: ERROR "No scenes planned - run /novel:outline first"
     - If all drafted: REPORT "All scenes drafted! Word count: [total]. Run /novel:check to verify quality."
   - Extract scene_id, chapter, scene number from found entry

   **Step 2: Load Scene Context**
   - Read beat sheet: beats/scenes/[scene_id].md
   - If missing: ERROR "Beat sheet not found - outline may be corrupted"
   - Determine format from story_state.json: project.format (diary, chapter, short_story, serial)
   - Locate previous scene:
     - If scene == 1 and chapter == 1: No previous scene
     - If scene == 1: Previous is last scene of previous chapter
     - Else: Previous is ch[X]_s[Y-1]
   - Load previous scene if exists: draft/scenes/[prev_id].md

   **Step 3: Spawn Scene-Writer Agent**
   - Pass context to scene-writer agent:
     - beat_sheet: beats/scenes/[scene_id].md
     - style_guide: canon/style_guide.md
     - characters: canon/characters.md
     - previous_scene: draft/scenes/[prev_id].md (if exists)
     - character_state: state/character_state.json
     - story_state: state/story_state.json
     - is_diary: (format == "diary")
     - diary_plan: beats/diary_plan.md (if diary format)
   - Agent executes: validates, loads context, generates prose, formats Markdown, updates state
   - Agent returns: scene_id, word_count, status

   **Step 4: Verify Scene Completion**
   - Check draft/scenes/[scene_id].md exists
   - Read file and verify YAML frontmatter is present
   - Verify status in story_state.json updated to "drafted"
   - If verification fails: ERROR "Scene generation failed - check agent output"

   **Step 5: Git Commit (if available)**
   - Use git-integration skill: commit_scene_completion(scene_id, title, word_count)
   - Format: "feat(draft): complete scene [scene_id] - [title]\n\nWord count: [count]\nStatus: drafted"
   - If git unavailable: Skip with silent degradation (no error)

   **Step 6: Report Completion**
   - Display:
     ```
     âœ“ Scene drafted: [scene_id]
     Title: [scene title from beat sheet]
     Word count: [count]
     Format: [diary/chapter]
     Status: drafted

     Progress: [N] of [total] scenes complete

     Continue to next scene? Type /novel:write
     ```

5. **Error Handling**:
   - Missing prerequisites: Guide user to run /novel:init or /novel:outline
   - Beat sheet missing: Suggest regenerating outline
   - Agent failure: Show agent error, suggest checking canon files
   - State corruption: Offer recovery suggestions

6. **Options** (future enhancement placeholders):
   - --scene [scene_id]: Draft specific scene (not first planned)
   - --continue: Draft next N scenes automatically
   - --dry-run: Show what would be drafted without generating

**Key implementation notes:**
- Follow RESEARCH.md /novel:write Command Pattern exactly
- Sequential execution: validate -> load -> spawn -> verify -> commit -> report
- Use state-manager skill for all state reads
- Agent does the state writes (not command)
- Git commit uses git-integration skill, graceful degradation if unavailable
- Continuation prompt encourages iterative drafting
  </action>
  <verify>
Read claude_src/novel/commands/write.md and confirm:
- Purpose section explains command workflow
- Prerequisites clearly listed
- 6 execution steps: Validate, Load Context, Spawn Agent, Verify, Git Commit, Report
- Error handling covers common failure modes
- Report format shows progress and encourages continuation
- File is 100+ lines with comprehensive command definition
  </verify>
  <done>
claude_src/novel/commands/write.md exists with complete command definition. Command validates prerequisites, finds next planned scene, spawns scene-writer agent with full context, verifies completion, commits to git if available, and reports progress to user.
  </done>
</task>

<task type="auto">
  <name>Create command symlink for discoverability</name>
  <files>.claude/commands/novel/write.md</files>
  <action>
Create symlink from .claude/commands/novel/write.md to ../../claude_src/novel/commands/write.md for command discoverability in Claude Code.

This follows the pattern established in Phase 1 for init.md, status.md, and outline.md - single source of truth in claude_src/, symlink for Claude Code command routing.

Use Bash tool:
```bash
ln -sf ../../claude_src/novel/commands/write.md .claude/commands/novel/write.md
```

Verify symlink created:
```bash
ls -la .claude/commands/novel/write.md
```

Expected output: Symlink pointing to ../../claude_src/novel/commands/write.md
  </action>
  <verify>
Check symlink exists and points to correct location:
```bash
ls -la .claude/commands/novel/write.md
readlink .claude/commands/novel/write.md
```

Should show symlink to ../../claude_src/novel/commands/write.md
  </verify>
  <done>
Symlink .claude/commands/novel/write.md created pointing to ../../claude_src/novel/commands/write.md. Command is now discoverable by Claude Code.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete drafting engine with scene-writer agent and /novel:write command. The system can now:
- Read beat sheets from outline
- Generate prose scenes in both diary and standard formats
- Output Markdown with YAML frontmatter
- Track emotional arcs and growth milestones
- Auto-commit completed scenes to git
- Report progress and encourage continuation
  </what-built>
  <how-to-verify>
Test the drafting engine end-to-end:

**Setup (if needed):**
1. If you don't have a test novel project, create one:
   ```bash
   cd /tmp/test-novel
   /novel:init
   ```
2. Fill in minimal canon files (premise, characters, style_guide)
3. Run `/novel:outline` to generate beat sheets

**Test scene drafting:**
1. Run `/novel:write` - should draft first scene
2. Verify output file: `cat draft/scenes/ch01_s01.md`
3. Check YAML frontmatter is present and valid
4. Verify prose quality:
   - Does it match the beat sheet goal?
   - Is character voice consistent with style_guide.md?
   - If diary format: Does it have date header and first-person retrospective voice?
   - If standard format: Does it follow POV/tense from style_guide?
5. Check state files updated:
   ```bash
   cat state/story_state.json | grep -A5 scene_index
   cat state/character_state.json | grep emotional_state
   ```
6. If git available, check commit:
   ```bash
   git log -1 --oneline
   ```

**Expected results:**
- Scene file exists with ~500-2000 words
- YAML frontmatter complete with scene_id, chapter, scene, pov, word_count, status: "drafted"
- Prose reads naturally, not mechanically following beat structure
- Character voice matches style guide
- State files show status changed from "planned" to "drafted"
- Git commit created with "feat(draft): complete scene ch01_s01" message

**Test continuation:**
1. Run `/novel:write` again - should draft second scene
2. Verify continuity: second scene references events from first scene appropriately

**Issues to flag:**
- Mechanical prose that reads like a checklist
- Missing or invalid YAML frontmatter
- Voice inconsistency with style guide
- State files not updated
- Scenes don't accomplish beat sheet goals
- Date inconsistencies in diary format
- Missing git commits (if git available)
  </how-to-verify>
  <resume-signal>
Type "approved" if drafting engine works correctly, or describe any issues found with specific examples.
  </resume-signal>
</task>

</tasks>

<verification>
Check /novel:write command:
1. Command follows pattern from init.md and outline.md
2. Validates prerequisites before attempting to draft
3. Finds next planned scene from scene_index
4. Spawns scene-writer agent with complete context
5. Verifies scene completion and state updates
6. Commits to git using git-integration skill
7. Reports progress with continuation prompt
8. Error handling guides user through common issues
9. Symlink created for command discoverability
10. Human verification confirms prose quality meets standards
</verification>

<success_criteria>
- [ ] claude_src/novel/commands/write.md exists with 100+ lines
- [ ] Command has purpose, prerequisites, and 6 execution steps
- [ ] Scene-writer agent spawned with full context (beat sheet, canon, state, previous scene)
- [ ] Git commit uses git-integration skill patterns
- [ ] Report shows progress and encourages continuation
- [ ] Error handling covers common failure scenarios
- [ ] Symlink .claude/commands/novel/write.md created
- [ ] Human verification confirms:
  - [ ] Scenes draft successfully from beat sheets
  - [ ] Prose quality is good (not mechanical)
  - [ ] Both diary and standard formats work
  - [ ] State files update correctly
  - [ ] Git commits created
  - [ ] Continuity maintained between scenes
</success_criteria>

<output>
After completion, create `.planning/phases/03-drafting-engine/03-02-SUMMARY.md`
</output>
