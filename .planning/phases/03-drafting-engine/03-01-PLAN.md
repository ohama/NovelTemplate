---
phase: 03-drafting-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - claude_src/novel/agents/scene-writer.md
autonomous: true

must_haves:
  truths:
    - "Agent can read beat sheet and generate prose scene"
    - "Diary format scenes include date headers and seasonal context"
    - "Standard format scenes follow style_guide.md constraints"
    - "Emotional state updates tracked in character_state.json"
    - "Scene output is Markdown with YAML frontmatter"
  artifacts:
    - path: "claude_src/novel/agents/scene-writer.md"
      provides: "Scene prose generation agent definition"
      min_lines: 200
      contains: "role.*execution.*validation"
  key_links:
    - from: "scene-writer agent"
      to: "beats/scenes/chXX_sYY.md"
      via: "read beat specification"
      pattern: "Read.*beats/scenes"
    - from: "scene-writer agent"
      to: "canon/style_guide.md"
      via: "load voice constraints"
      pattern: "canon/style_guide"
    - from: "scene-writer agent"
      to: "state-manager skill"
      via: "update state files"
      pattern: "load_state|save_state"
---

<objective>
Build the scene-writer agent that transforms beat sheets into polished prose scenes with full diary format support and Markdown output.

Purpose: This agent is the core prose generator of the drafting engine. It reads structured beat specifications and generates narrative prose that maintains character voice, tracks emotional arcs, handles diary format conventions (dates, seasons, first-person retrospective), and outputs well-formatted Markdown scenes with YAML frontmatter.

Output: A complete agent definition file following the established pattern from plot-planner and beat-planner agents, ready to be spawned by /novel:write command.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-drafting-engine/03-RESEARCH.md

# Prior agent patterns
@claude_src/novel/agents/plot-planner.md
@claude_src/novel/agents/beat-planner.md
@claude_src/novel/agents/diary-planner.md

# Skills and utilities
@claude_src/novel/utils/state-manager.md
@claude_src/novel/skills/git-integration.md

# Schemas for state structure
@claude_src/novel/schemas/story_state.schema.json
@claude_src/novel/schemas/character_state.schema.json
@claude_src/novel/schemas/timeline_state.schema.json
</context>

<tasks>

<task type="auto">
  <name>Create scene-writer agent definition</name>
  <files>claude_src/novel/agents/scene-writer.md</files>
  <action>
Create novel-scene-writer agent following the established agent pattern (YAML frontmatter + role + execution + validation).

**Agent structure:**

1. **Frontmatter** (YAML):
   - name: scene-writer
   - description: Generate prose scenes from beat specifications with diary format support
   - allowed-tools: [Read, Write, Bash]
   - version: 1.0

2. **Purpose section**:
   - Input: beats/scenes/chXX_sYY.md (beat sheet)
   - Output: draft/scenes/chXX_sYY.md (prose scene)
   - Updates: story_state.json, character_state.json, timeline_state.json (if diary)
   - Explain role as prose generator following beat structure

3. **Role section** (in XML tags):
   - Job: Read beat sheet, load canon/state context, generate prose, update state
   - What you create: Polished narrative prose (500-2000 words) matching beat spec
   - Principles:
     - Beat sheet is structure, not prose template (avoid mechanical following)
     - Maintain character voice from style_guide.md
     - Track emotional state changes in character_state.json
     - Diary format uses first-person retrospective with date headers
     - Standard format follows style_guide POV/tense constraints
     - Always read previous scene for continuity

4. **Execution section** with 5 steps:

   **Step 1: Validate Input**
   - Check beat sheet exists (beats/scenes/chXX_sYY.md)
   - Check canon files exist (style_guide.md, characters.md)
   - Load state files (story_state.json, character_state.json)
   - If diary format, check diary_plan.md exists
   - Error if beat sheet missing: "Beat sheet not found - run /novel:outline first"

   **Step 2: Load Context**
   - Read beat sheet to understand scene structure (purpose, conflict, outcome, emotional beat)
   - Read previous scene (draft/scenes/ch[X]_s[Y-1].md) for continuity
   - Load canon/style_guide.md for voice constraints (POV, tense, forbidden phrases)
   - Load canon/characters.md for character details
   - Load character_state.json for current emotional states
   - If diary format: Load beats/diary_plan.md for date/season/weather info

   **Step 3: Generate Prose**
   - Write prose following beat structure but NOT mechanically
   - Match style_guide constraints (POV, tense, voice)
   - Include character voice from style_guide and character profiles
   - For diary format:
     - Use first-person past tense retrospective voice
     - Add date header (format: "# January 10, 2024 - Thursday")
     - Add time header if specified (format: "## Evening, 9:30 PM")
     - Include seasonal context naturally in prose (don't force weather descriptions)
     - Track emotional state and growth milestones in HTML comments
   - For standard format:
     - Follow style_guide POV and tense
     - Add chapter/scene header (format: "# Chapter 1, Scene 1")
     - Include beat summary in HTML comment at end
   - Target word count from beat sheet (typically 500-2000 words)
   - Show don't tell for high-intensity beats, tell for transitions

   **Step 4: Format Markdown Output**
   - Create YAML frontmatter with scene metadata:
     - scene_id, chapter, scene, pov, word_count, status: "drafted"
     - For diary: date (YYYY-MM-DD), time (HH:MM), season, weather
     - For diary: emotional_state, growth_milestone (if applicable)
   - Write prose with proper headers
   - Add HTML comments for tracking (beat summary, emotional notes)
   - Write to draft/scenes/chXX_sYY.md

   **Step 5: Update State Files**
   - Use state-manager skill patterns for all updates
   - Update story_state.json:
     - scene_index[scene_id].status = "drafted"
     - scene_index[scene_id].word_count = [actual count]
     - current.chapter = [chapter number]
     - current.scene = [scene number]
     - current.date = [date] (if diary format)
     - progress.total_word_count += [scene word count]
   - Update character_state.json if emotional state changed:
     - characters[name].emotional_state = [new state]
     - characters[name].last_appearance = [scene_id]
     - If milestone reached: Update arc_stage
   - If diary format, update timeline_state.json:
     - Add event entry with date, description, scene_id
   - Write file FIRST, then update state (avoid desync)

5. **Validation section**:
   - Verify draft/scenes/chXX_sYY.md exists and has content
   - Verify YAML frontmatter is valid and complete
   - Verify word count is within reasonable range (300-3000 words)
   - Verify state files updated successfully
   - Check scene accomplishes beat sheet goals
   - Report: "Scene [scene_id] drafted: [title], [word_count] words, status: drafted"

6. **Examples section**:
   - Include diary format example with full YAML + date header + prose snippet
   - Include standard format example with YAML + chapter header + prose snippet
   - Show HTML comment patterns for tracking

**Key implementation notes:**
- Follow RESEARCH.md patterns exactly (Scene-Writer Agent Workflow, Diary Entry Format, State Update After Scene)
- Avoid pitfalls: mechanical prose, voice drift, date inconsistency, state desync
- Use ISO 8601 dates (YYYY-MM-DD) consistently
- Read dates from diary_plan.md, don't generate new dates
- State update is atomic: file write first, then state update
- Word count calculation: split on whitespace, simple is sufficient
  </action>
  <verify>
Read claude_src/novel/agents/scene-writer.md and confirm:
- YAML frontmatter complete with name, description, allowed-tools, version
- Role section explains job and principles
- Execution has 5 steps: Validate Input, Load Context, Generate Prose, Format Markdown Output, Update State Files
- Validation section specifies checks and reporting
- Examples include both diary and standard format
- File is 200+ lines with comprehensive agent definition
  </verify>
  <done>
claude_src/novel/agents/scene-writer.md exists with complete agent definition following established pattern. Agent can read beat sheets, generate prose for both diary and standard formats, output Markdown with YAML frontmatter, and update state files using state-manager patterns.
  </done>
</task>

</tasks>

<verification>
Check scene-writer agent definition:
1. Agent follows pattern from plot-planner, beat-planner, diary-planner
2. Execution steps cover full workflow: validation -> context loading -> prose generation -> Markdown output -> state update
3. Diary format handling is conditional within same agent (not separate system)
4. State update uses state-manager skill patterns
5. Markdown output includes YAML frontmatter and proper headers
6. Examples demonstrate both diary and standard formats
</verification>

<success_criteria>
- [ ] claude_src/novel/agents/scene-writer.md exists with 200+ lines
- [ ] YAML frontmatter defines agent metadata
- [ ] Role section explains prose generation job
- [ ] Execution has 5 structured steps
- [ ] Diary format support integrated (date headers, seasonal context, emotional tracking)
- [ ] Standard format support included (chapter headers, beat comments)
- [ ] State update patterns use state-manager skill
- [ ] Validation section specifies checks
- [ ] Examples show both formats with YAML frontmatter
- [ ] Agent definition is ready to be spawned by /novel:write command
</success_criteria>

<output>
After completion, create `.planning/phases/03-drafting-engine/03-01-SUMMARY.md`
</output>
