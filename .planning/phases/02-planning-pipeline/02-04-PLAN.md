---
phase: 02-planning-pipeline
plan: 04
type: execute
wave: 2
depends_on: ["02-01", "02-02", "02-03"]
files_modified:
  - claude_src/novel/commands/outline.md
  - .claude/commands/novel/outline.md
autonomous: true

must_haves:
  truths:
    - "User can run /novel:outline and see outline generation process"
    - "Command validates canon files exist before starting"
    - "Command spawns plot-planner, then beat-planner, conditionally diary-planner"
    - "Command commits results to git with descriptive message"
    - "User sees success message with generated file locations"
  artifacts:
    - path: "claude_src/novel/commands/outline.md"
      provides: "/novel:outline orchestration logic"
      min_lines: 150
      contains: ["<command>", "plot-planner", "beat-planner", "diary-planner"]
    - path: ".claude/commands/novel/outline.md"
      provides: "Symlink for command discoverability"
      type: "symlink"
  key_links:
    - from: "/novel:outline command"
      to: "plot-planner agent"
      via: "TeammateTool spawn"
      pattern: "spawn.*plot-planner"
    - from: "/novel:outline command"
      to: "beat-planner agent"
      via: "Sequential spawn after plot-planner"
      pattern: "spawn.*beat-planner"
    - from: "/novel:outline command"
      to: "git-integration skill"
      via: "commit_outline function"
      pattern: "commit_outline"
---

<objective>
Create the /novel:outline command that orchestrates the three planning agents to generate complete story structure.

Purpose: Provides user-facing command that coordinates plot-planner, beat-planner, and diary-planner agents to transform canon files into actionable story plans, with validation and git integration.

Output: /novel:outline command skill that validates inputs, spawns agents sequentially, updates state files, commits results, and reports success to user with file locations.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-planning-pipeline/02-RESEARCH.md
@.planning/phases/01-foundation-canon-system/01-02-SUMMARY.md
@claude_src/novel/commands/init.md
@claude_src/novel/commands/status.md
@claude_src/novel/skills/git-integration.md
@claude_src/novel/utils/state-manager.md
</context>

<tasks>

<task type="auto">
  <name>Create /novel:outline command with agent orchestration</name>
  <files>
    claude_src/novel/commands/outline.md
    .claude/commands/novel/outline.md
  </files>
  <action>
Create command skill following Phase 1 command pattern (from init.md, status.md).

**Structure for outline.md:**

```markdown
---
name: outline
description: Generate story outline, beat plan, and diary structure from canon
tags: [planning, outline, beats, agents]
version: 1.0.0
---

<command>
# /novel:outline - Generate Story Structure

Orchestrates plot-planner, beat-planner, and diary-planner agents to transform canon into structured story plans.

## Usage

```bash
/novel:outline
```

## What It Does

1. Validates canon files (premise.md, characters.md required)
2. Spawns plot-planner to generate beats/outline.md
3. Spawns beat-planner to generate beats/scenes/*.md
4. Conditionally spawns diary-planner if format == "diary"
5. Updates state files with planning progress
6. Commits results to git

## Requirements

- Canon files must exist (from /novel:init)
- state/story_state.json must exist
- Project not already outlined (checks progress.outline)

</command>

<execution>

## Step 1: Validate Environment

Check prerequisites:
1. Verify canon/premise.md exists - ERROR if missing "Run /novel:init first"
2. Verify canon/characters.md exists - ERROR if missing
3. Read state/story_state.json - get project.format, progress.outline
4. If progress.outline == "complete": WARN "Outline already exists. Regenerate? (overwrites beats/)"

If user confirms regeneration or no outline exists: Continue

## Step 2: Prepare beats/ Directory

Create/clean beats directory:
1. Create beats/ if doesn't exist
2. Create beats/scenes/ subdirectory
3. If regenerating: Move existing beats/ to beats.backup.[timestamp]

## Step 3: Spawn plot-planner Agent

Use TeammateTool (or similar agent spawning mechanism):

```
Spawn agent: @claude_src/novel/agents/plot-planner.md

Wait for completion.

Verify output:
- beats/outline.md exists
- story_state.json updated with progress.outline = "complete"
```

If plot-planner fails: ERROR and exit

## Step 4: Spawn beat-planner Agent

After plot-planner succeeds:

```
Spawn agent: @claude_src/novel/agents/beat-planner.md

Wait for completion.

Verify output:
- beats/scenes/*.md files exist (at least 1)
- story_state.json updated with scene_index
- character_state.json updated with scene_appearances
```

If beat-planner fails: ERROR and exit

## Step 5: Conditionally Spawn diary-planner

Check story format:

```
If story_state.json project.format == "diary":
  Spawn agent: @claude_src/novel/agents/diary-planner.md

  Wait for completion.

  Verify output:
  - beats/diary_plan.md exists
  - story_state.json has diary_metadata
```

If format != "diary": Skip this step

## Step 6: Git Commit

Use git-integration skill (from Phase 1):

```
Call commit_outline() function with message:
"Generate story outline and beat plan

- Structure: [3-act/5-act from story_state]
- Chapters: [count from outline.md]
- Scenes: [count from scene_index]
- Format: [chapter/diary from story_state]"
```

Stage files:
- beats/outline.md
- beats/scenes/*.md
- beats/diary_plan.md (if exists)
- state/story_state.json
- state/character_state.json
- state/timeline_state.json (if updated)

## Step 7: Report Success

Display to user:

```
✓ Story outline complete

Structure: [3-act/5-act]
Chapters: [X]
Scenes: [Y]
Format: [chapter/diary]

Generated files:
- beats/outline.md
- beats/scenes/ ([Y] scene beat sheets)
[if diary] - beats/diary_plan.md

Next step: Review beats/outline.md and run /novel:write to start drafting
```

</execution>

<error_handling>

**Missing canon files:**
- Check premise.md and characters.md exist before starting
- Provide clear error: "Missing canon/premise.md. Run /novel:init first."

**Agent failures:**
- If agent returns error, don't proceed to next agent
- Rollback: Remove partially generated beats/ if incomplete
- Restore from beats.backup if regeneration failed

**Git failures:**
- Use graceful degradation from git-integration skill
- Warn user but don't block workflow

</error_handling>

<validation>

After command completes:
1. beats/outline.md exists and is valid markdown
2. beats/scenes/ contains .md files matching scene count
3. story_state.json progress.outline == "complete"
4. Git commit created (if git available)

</validation>
```

**Create symlink:**
After writing outline.md, create symlink for discoverability:

```bash
mkdir -p .claude/commands/novel
ln -sf ../../../claude_src/novel/commands/outline.md .claude/commands/novel/outline.md
```

**Implementation notes:**
- Follow init.md pattern for command structure
- Use TeammateTool or equivalent for agent spawning
- Sequential execution (plot → beat → diary), not parallel
- Graceful degradation for git (from git-integration skill)
- Backup existing beats/ before regeneration
  </action>
  <verify>
1. Check command file: `ls claude_src/novel/commands/outline.md`
2. Verify symlink: `ls -l .claude/commands/novel/outline.md | grep "outline.md"`
3. Check agent references: `grep -c "plot-planner\|beat-planner\|diary-planner" claude_src/novel/commands/outline.md` returns at least 3
4. Verify git integration: `grep "commit_outline\|git-integration" claude_src/novel/commands/outline.md`
  </verify>
  <done>
outline.md command exists with complete orchestration logic (validate, prepare, spawn agents sequentially, commit, report). Symlink created for command discoverability. Command coordinates all three planning agents and uses git-integration for auto-commit.
  </done>
</task>

</tasks>

<verification>

After plan completion:
- [ ] outline.md exists in claude_src/novel/commands/
- [ ] Symlink exists in .claude/commands/novel/
- [ ] Command orchestrates all three agents sequentially
- [ ] Validation and error handling included
- [ ] Git integration using git-integration skill
- [ ] Success reporting with file locations
- [ ] Follows Phase 1 command pattern

</verification>

<success_criteria>

Plan 02-04 complete when:
- /novel:outline command created with full orchestration
- Agent spawning logic documented
- Sequential execution (plot → beat → diary)
- Conditional diary-planner invocation based on format
- Git commit integration included
- User can run /novel:outline to generate complete story structure

</success_criteria>

<output>
After completion, create `.planning/phases/02-planning-pipeline/02-04-SUMMARY.md`
</output>
