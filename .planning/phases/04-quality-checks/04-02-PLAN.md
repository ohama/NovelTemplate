---
phase: 04-quality-checks
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - claude_src/novel/agents/voice-coach.md
  - claude_src/novel/agents/pacing-analyzer.md
autonomous: true

must_haves:
  truths:
    - "Voice coach detects POV violations and head-hopping"
    - "Voice coach flags tense inconsistencies with specific line references"
    - "Voice coach identifies forbidden phrase usage"
    - "Pacing analyzer evaluates scene length vs beat sheet targets"
    - "Pacing analyzer detects rushed climactic scenes and dragging transitions"
    - "Both checkers output JSON with severity levels and fix suggestions"
  artifacts:
    - path: "claude_src/novel/agents/voice-coach.md"
      provides: "Voice and style consistency verification agent"
      min_lines: 200
      contains: "role.*execution.*validation"
    - path: "claude_src/novel/agents/pacing-analyzer.md"
      provides: "Pacing and rhythm analysis agent"
      min_lines: 200
      contains: "role.*execution.*validation"
  key_links:
    - from: "voice-coach agent"
      to: "canon/style_guide.md"
      via: "load POV, tense, forbidden phrases"
      pattern: "style_guide"
    - from: "voice-coach agent"
      to: "state/character_state.json"
      via: "load voice_notes per character"
      pattern: "character_state"
    - from: "pacing-analyzer agent"
      to: "beats/scenes/*.md"
      via: "load target word counts"
      pattern: "beats/scenes"
    - from: "pacing-analyzer agent"
      to: "state/story_state.json"
      via: "load scene_index with word counts"
      pattern: "story_state"
---

<objective>
Build the novel-voice-coach and novel-pacing-analyzer agents for detecting voice inconsistencies and pacing issues across draft scenes.

Purpose: These two checkers form the style and rhythm layer of the quality system. Voice coach ensures POV consistency, tense adherence, forbidden phrase avoidance, and character voice maintenance. Pacing analyzer ensures scenes hit their word count targets and maintain appropriate rhythm for their beat type.

Output: Two complete agent definitions following the established pattern, ready to be spawned in parallel by /novel:check command.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-quality-checks/04-RESEARCH.md

# Existing agent patterns
@claude_src/novel/agents/scene-writer.md
@claude_src/novel/agents/plot-planner.md

# Skills and utilities
@claude_src/novel/utils/state-manager.md

# Schemas for state structure
@claude_src/novel/schemas/story_state.schema.json
@claude_src/novel/schemas/character_state.schema.json
@claude_src/novel/schemas/style_state.schema.json

# Canon templates for reference
@claude_src/novel/templates/style_guide.md
@claude_src/novel/templates/characters.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create voice-coach agent definition</name>
  <files>claude_src/novel/agents/voice-coach.md</files>
  <action>
Create novel-voice-coach agent following the established agent pattern (YAML frontmatter + role + execution + validation).

**Agent structure:**

1. **Frontmatter** (YAML):
   - name: voice-coach
   - description: Detect POV violations, tense shifts, forbidden phrases, and voice inconsistencies
   - allowed-tools: [Read, Glob, Grep]
   - version: 1.0

2. **Purpose section**:
   - Inputs: canon/style_guide.md, canon/characters.md, state/character_state.json, state/style_state.json, draft/scenes/*.md
   - Outputs: JSON with issues array and summary
   - Role: Verify voice consistency across POV, tense, style rules, and character patterns

3. **Role section** (in XML tags):
   - Job: Load style constraints, analyze prose for violations, flag inconsistencies
   - What you check:
     - POV consistency (no head-hopping in third_limited)
     - Tense consistency (no slippage between past and present)
     - Forbidden phrases not used (exact match from style_guide.md)
     - Cliche watchlist items flagged (from style_state.json)
     - Character dialogue matches voice_notes patterns
     - Narrative voice matches style guide characteristics
   - Principles:
     - CRITICAL severity for POV violations (seeing other character's thoughts in limited POV)
     - MAJOR severity for tense shifts, forbidden phrases
     - MINOR severity for cliche usage, slight voice drift
     - Consider character arc_stage when evaluating voice drift (early vs late voice differs)
     - Include specific line/paragraph evidence

4. **Execution section** with 4 steps:

   **Step 1: Load Style Constraints**
   - Read canon/style_guide.md:
     - Extract POV type (first, third_limited, third_omniscient)
     - Extract tense (past, present)
     - Extract forbidden_phrases array
     - Extract voice_characteristics (tone, sentence structure, narrative distance)
   - Read state/style_state.json:
     - Get cliche_watchlist
     - Get any additional forbidden phrases
   - Read state/character_state.json:
     - For each character, extract voice_notes (speech patterns, vocabulary, mannerisms)
     - Extract arc_stage for each character (affects expected voice)

   **Step 2: Scan for POV Violations**
   - For each draft scene:
     - Identify POV character from frontmatter
     - If POV is "third_limited":
       - Scan for other characters' thoughts/feelings (head-hopping indicators)
       - Patterns: "he wondered what she thought", "secretly she felt", internal state of non-POV character
       - Flag as CRITICAL: "POV violation - accessing [character]'s internal state"
     - If POV is "first":
       - Scan for omniscient narrator statements
       - Flag if narrator knows things character couldn't know
   - Record line numbers and evidence for each violation

   **Step 3: Scan for Style Violations**
   - For each draft scene:
     a. **Tense Check:**
        - Identify dominant tense from style_guide
        - Scan for verb forms inconsistent with expected tense
        - Past tense: Flag present tense verbs in narrative (not dialogue)
        - Present tense: Flag past tense verbs in narrative
        - Record: "Line [X]: '[verb phrase]' - expected [tense], found [actual]"
        - Severity: MAJOR for clear tense shifts

     b. **Forbidden Phrases:**
        - For each phrase in forbidden_phrases:
          - Search scene content (case-insensitive exact match)
          - If found: MAJOR issue with line reference
        - For each phrase in cliche_watchlist:
          - Search scene content
          - If found: MINOR issue (flag, don't fail)

     c. **Character Voice:**
        - Identify dialogue segments
        - For POV character, check narrative voice against voice_notes
        - For all characters, check dialogue against their speech_patterns
        - Consider arc_stage: Voice drift acceptable if matches arc progression
        - If significant deviation from established patterns:
          - MINOR: "Voice drift detected - [character] vocabulary differs from voice_notes"
          - Include evidence: expected patterns vs found patterns

   **Step 4: Generate Output**
   - Create JSON output:
     ```json
     {
       "checker": "voice-coach",
       "timestamp": "[ISO 8601]",
       "scenes_checked": [count],
       "issues": [
         {
           "severity": "CRITICAL|MAJOR|MINOR",
           "scene_id": "chXX_sYY",
           "type": "pov_violation|tense_shift|forbidden_phrase|cliche|voice_drift",
           "description": "[what's wrong]",
           "evidence": {
             "expected": "[from style guide/voice notes]",
             "found": "[from scene]",
             "line": "[line number or quote]"
           },
           "suggestion": "[how to fix]"
         }
       ],
       "summary": {
         "critical": [count],
         "major": [count],
         "minor": [count],
         "passed": true|false
       }
     }
     ```

5. **Validation section**:
   - Verify all scenes scanned
   - Verify forbidden_phrases list was checked
   - Report: "Voice check complete: [total] issues"

6. **Examples section**:
   - Example: POV violation (CRITICAL) - head-hopping in third limited
   - Example: Tense shift (MAJOR) - present tense in past narrative
   - Example: Forbidden phrase used (MAJOR)
   - Example: Voice drift (MINOR) - vocabulary inconsistency

**Key implementation notes:**
- Don't flag dialogue for tense (characters can speak in any tense)
- Voice drift threshold: Compare against arc_stage-appropriate voice
- Forbidden phrases are exact match, case-insensitive
- Head-hopping detection requires understanding POV type
  </action>
  <verify>
Read claude_src/novel/agents/voice-coach.md and confirm:
- YAML frontmatter with name, description, allowed-tools, version
- Role section explains voice verification job
- Execution has 4 steps: Load Style Constraints, Scan for POV Violations, Scan for Style Violations, Generate Output
- POV violation detection documented (head-hopping patterns)
- Tense consistency checking documented
- Forbidden phrase matching documented
- Voice drift handling considers arc_stage
- File is 200+ lines
  </verify>
  <done>
claude_src/novel/agents/voice-coach.md exists with complete agent definition. Agent can load style constraints, detect POV violations, flag tense shifts, identify forbidden phrases, track voice consistency, and output structured JSON with severity-classified issues.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create pacing-analyzer agent definition</name>
  <files>claude_src/novel/agents/pacing-analyzer.md</files>
  <action>
Create novel-pacing-analyzer agent following the established agent pattern.

**Agent structure:**

1. **Frontmatter** (YAML):
   - name: pacing-analyzer
   - description: Evaluate scene rhythm, word count distribution, and pacing balance
   - allowed-tools: [Read, Glob, Grep]
   - version: 1.0

2. **Purpose section**:
   - Inputs: beats/scenes/*.md (target word counts), draft/scenes/*.md (actual scenes), state/story_state.json (scene_index with word counts)
   - Outputs: JSON with issues array and summary
   - Role: Evaluate pacing balance by comparing actual vs expected scene lengths

3. **Role section** (in XML tags):
   - Job: Compare scene lengths to beat targets, analyze rhythm, identify pacing problems
   - What you check:
     - Scene length vs beat sheet target word count
     - Sentence length variation (monotonous rhythm detection)
     - Balance of action/dialogue/description ratios
     - Chapter pacing across scenes
     - Rushed climactic scenes (high-intensity beats underwritten)
     - Dragging transition scenes (low-intensity beats overwritten)
   - Principles:
     - Deviation thresholds: >30% = MINOR, >50% = MAJOR, >100% = investigate
     - Consider scene type when evaluating: climax > transition
     - Don't flag every scene - only significant deviations
     - Provide context: "Target was X, actual is Y (Z% deviation)"

4. **Execution section** with 4 steps:

   **Step 1: Load Pacing Expectations**
   - Use Glob to find beats/scenes/*.md files
   - For each beat sheet, extract:
     - scene_id
     - target_word_count (from frontmatter or estimated length)
     - beat_type (from Save the Cat beat mapping, if present)
     - intensity (high, medium, low based on beat)
   - Read state/story_state.json:
     - Get scene_index with actual word counts
   - Build expectations map: { scene_id: { target, beat_type, intensity } }

   **Step 2: Calculate Deviations**
   - For each scene in scene_index:
     - Get actual word_count from scene entry
     - Get target from expectations map
     - Calculate deviation: ((actual - target) / target) * 100
     - Record: { scene_id, target, actual, deviation_percent, intensity }
   - Identify significant deviations:
     - If |deviation| > 30% AND |deviation| <= 50%: MINOR
     - If |deviation| > 50% AND |deviation| <= 100%: MAJOR
     - If |deviation| > 100%: Flag for investigation
   - Consider intensity:
     - High-intensity scene (climax, midpoint) underwritten: Escalate severity
     - Low-intensity scene overwritten: Flag as potential drag

   **Step 3: Analyze Rhythm (Optional Deep Analysis)**
   - For scenes with MAJOR deviations, analyze further:
     a. **Sentence Length Variation:**
        - Read scene content
        - Calculate sentence lengths (split on .!?)
        - If >80% of sentences within 10% of average: Flag monotonous rhythm
     b. **Content Balance:**
        - Estimate dialogue percentage (lines starting with " or dialogue tags)
        - Estimate action percentage (short sentences, verbs of motion)
        - Estimate description percentage (long sentences, sensory words)
        - If severely imbalanced for scene type: Flag
   - This step is optional - only for scenes already flagged

   **Step 4: Generate Output**
   - Create JSON output:
     ```json
     {
       "checker": "pacing-analyzer",
       "timestamp": "[ISO 8601]",
       "scenes_checked": [count],
       "issues": [
         {
           "severity": "MAJOR|MINOR",
           "scene_id": "chXX_sYY",
           "type": "underwritten|overwritten|monotonous_rhythm|imbalanced_content",
           "description": "[what's wrong]",
           "evidence": {
             "target_words": [number],
             "actual_words": [number],
             "deviation_percent": "[X]%",
             "beat_type": "[type if known]"
           },
           "suggestion": "[how to fix - expand, trim, vary rhythm, etc.]"
         }
       ],
       "summary": {
         "critical": 0,
         "major": [count],
         "minor": [count],
         "passed": true|false,
         "total_word_count": [sum],
         "average_scene_length": [avg],
         "deviation_stats": {
           "on_target": [count scenes within 30%],
           "minor_deviation": [count],
           "major_deviation": [count]
         }
       }
     }
     ```
   - Note: Pacing issues are never CRITICAL (won't block publish alone)

5. **Validation section**:
   - Verify all scenes with targets were analyzed
   - Verify deviation calculations are correct
   - Report: "Pacing analysis complete: [on_target] scenes on target, [flagged] scenes flagged"

6. **Examples section**:
   - Example: Climax scene underwritten (MAJOR) - only 500 words for major beat
   - Example: Transition scene overwritten (MINOR) - 2000 words for simple transition
   - Example: Good pacing report showing deviation stats

**Key implementation notes:**
- Not all beat sheets have explicit target_word_count - estimate from beat type
- Save the Cat beat mappings: Opening Image ~1%, Midpoint ~50% (more important = longer)
- Don't flag scenes without beat sheet targets (can't compare)
- Pacing is subjective - use thresholds not absolutes
- Rhythm analysis is expensive - only do for already-flagged scenes
  </action>
  <verify>
Read claude_src/novel/agents/pacing-analyzer.md and confirm:
- YAML frontmatter with name, description, allowed-tools, version
- Role section explains pacing evaluation job
- Execution has 4 steps: Load Pacing Expectations, Calculate Deviations, Analyze Rhythm, Generate Output
- Deviation thresholds documented (30%, 50%, 100%)
- Intensity consideration documented (climax vs transition)
- No CRITICAL severity (pacing alone shouldn't block)
- Summary includes deviation statistics
- File is 200+ lines
  </verify>
  <done>
claude_src/novel/agents/pacing-analyzer.md exists with complete agent definition. Agent can load beat sheet targets, calculate word count deviations, analyze rhythm patterns, and output structured JSON with severity-classified pacing issues and statistics.
  </done>
</task>

</tasks>

<verification>
Check both analyzer agents:
1. Both follow established agent pattern (frontmatter + role + execution + validation)
2. Both output JSON following the schema defined in RESEARCH.md
3. Voice coach handles: POV violations, tense shifts, forbidden phrases, voice drift
4. Pacing analyzer handles: word count deviations, rhythm analysis, beat type consideration
5. Both include evidence and suggestions in each issue
6. Both are ready to be spawned in parallel by /novel:check
</verification>

<success_criteria>
- [ ] claude_src/novel/agents/voice-coach.md exists with 200+ lines
- [ ] claude_src/novel/agents/pacing-analyzer.md exists with 200+ lines
- [ ] Both have YAML frontmatter with name, description, allowed-tools, version
- [ ] Both have role sections explaining their analysis job
- [ ] Both have 4-step execution workflows
- [ ] Voice coach validates: POV, tense, forbidden phrases, character voice
- [ ] Pacing analyzer validates: word counts, rhythm, beat type considerations
- [ ] Both output JSON with severity levels and fix suggestions
- [ ] Both are ready to be spawned by /novel:check command
</success_criteria>

<output>
After completion, create `.planning/phases/04-quality-checks/04-02-SUMMARY.md`
</output>
